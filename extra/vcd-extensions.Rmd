---
title: "vcd/vcdExtra Upgrades"
author: "Michael Friendly"
date: "`r Sys.Date()`"
output: 
  html_document
---


```{r knitr-options, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,   # avoid warnings and messages in the output
  message = FALSE)
```

Notes on some {vcd} and {vcdExtra} functions that could be made more usable, better documented or illustrated in examples

## `vcd::woolf_test()` for homogeneity of odds ratios
## 
Only handles 3-way tables, 2 x 2 x k. Could extend this simply to the 2 x 2 x R x C case by taking all the R x C strata
together, making this into a 2 x 2 x k table where k=R*C

e.g., for the `Fungicide` data, 2 x 2 x 2 x 2, `woolf_test()` gives an uninformative error.

```{r error=TRUE}
library(vcdExtra)
data(Fungicide, package = "vcdExtra")
# rearrange `group` for ease of interpretation, so odds ratio > 1 means worse outcome for Treated group
Fungicide <- Fungicide[2:1, , , ]
ftable(sex + strain ~ outcome + group, data=Fungicide)

oddsratio(Fungicide) |>
  summary()

#' Woolf test only only handles 2 x 2 x k tables
try(woolf_test(Fungicide))
```

#### Visualize the odds ratios

```{r fourfold}
fourfold(Fungicide, p_adjust_method = "none")
```

### Generalized `woolf_test()`
I generalized this in two ways:

#### Allow 3+ dimension

All dimensions after the first two are coalesced into a single 3rd dimension consisting of the combinations of all levels of these dimensions. We get a single overall test of differences
in odds ratios for the collection of 2 x 2 tables.

```{r woolf-general}
source(here::here("extra", "woolf_test_general.R"))

woolf_test_general(Fungicide)
```

Source code: [woolf_test_general.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_general.R)


#### Four-way case of 2 x 2 x R x C

A more interesting generalization for the four-way case of 2 x 2 x R x C is to
treat the odds ratios as two-ways table of size R x C and calculate 
Woolf's test over rows, columns and for the residual.

```{r woolf-2way}
source(here::here("extra", "woolf_test_2way.R"))

woolf_test_2way(Fungicide)
```

Source code: [woolf_test_2way.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_2way.R)

**TODO**: These ideas could be incorporated into `vcd::woolf_test()`, but I'm not sure quite how.

