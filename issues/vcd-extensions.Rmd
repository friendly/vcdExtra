---
title: "vcd/vcdExtra Upgrades"
author: "Michael Friendly"
date: "`r Sys.Date()`"
output: 
  html_document
---


```{r knitr-options, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,   # avoid warnings and messages in the output
  message = FALSE)
```

Here are some notes on some {vcd} and {vcdExtra} functions that could be made more usable, better documented or illustrated in examples.

They are prompted by the fact that I'm teaching my [Categorical Data Analysis course]() again this year, but also from the view that
statistical and graphic methods for categorical data have lagged far behind recent developments for traditional quantitative data.

## vcd documentation

I recently did an overhaul of {vcdExtra} to 

* Convert `.Rd` documentation to `roxygen` format. That was painful, because the {rd2roxygen} package made a mess of formatting, but the result is now much easier to maintain and extend. A benefit was that all datasets in the package are now documented in a single file, `R/data.R`, facilitating maintenance.

* Group statistical and graphic methods in broader categories for user ease in seeing what's related. Most functions use `@seealso`, but the documentation
is much clearer using `@family` tags.  I introduced the following in {vcdExtra} and this kind of classification would be very useful in {vcd}.

```r
# Mosaic plotting functions
@family mosaic plots
# Functions: mosaic.glm, mosaic.glmlist, mosaic3d, sieve.glm, assoc.glm

# Model list utilities
@family glmlist functions
# Functions: glmlist, print.glmlist, LRstats, Kway, mosaic.glmlist

# Statistical tests
@family association tests
# Functions: CMHtest, GKgamma, HLtest, zero.test

# Loglinear model utilities
@family loglinear models
# Functions: seq_loglm, loglmlist, conditional, joint, mutual, markov, saturated

# Data manipulation
@family data manipulation
# Functions: expand.dft, collapse.table, cutfac, datasets

# Model comparison
@family model comparison
# Functions: LRstats, Summarise, modFit, Kway
```

### `@concept` tags

* Provide a better way to use / understand the many datasets provided by the package. For this, I introduced `@concept` tags in the {heplots} package documentation to classify each dataset according to the methods applicable to them. I also applied this idea to the {HistData} package. The vignette [Data sets in the heplots package](https://friendly.github.io/heplots/articles/datasets.html) describes how this was done. 

  * What are the "concepts" for vcd/vcdExtra datasets? I've done the initial steps on this: (a) A classification scheme based on categories of
  **Statistical Methods**, **Data Structures**, **Graphical Methods**, ... For example:

```
### 1. **Statistical Methods** (primary analysis techniques)
- `loglinear-models` - Datasets for loglinear model analysis (~40+ datasets)
- `logistic-regression` - Binary/multinomial logistic models (Donner, ICU, Accident, Titanicp)
- `poisson-regression` - Poisson GLM applications (Accident, Cormorants, DaytonSurvey)
- `correspondence-analysis` - CA methods (AirCrash, Asbestos, HairEyePlace, HospVisits, Mental)
- `association-models` - Quasi-independence, RC models (Hauser79, Yamaguchi87, JobSat)
- `observer-agreement` - Agreement/reliability analysis (Mammograms)
- `count-models` - Zero-inflated, negative binomial (PhdPubs, CyclingDeaths, Depends)

### 2. **Data Structures**
- `two-way-table` - 2D contingency tables (Glass, JobSat, Mammograms, Mobility)
- `multi-way-table` - 3+ dimensional tables (Abortion, Bartlett, Caesar, Dyke, Heckman)
- `square-table` - Same categories for rows/columns (Glass, Hauser79, Mobility, Yamaguchi87)
- `stratified-table` - Layered analysis (Fungicide, Heart, HairEyePlace, Yamaguchi87)
- `ordered-factors` - Ordinal variables (Accident, Asbestos, JobSat, Mental, Toxaemia)
- `case-form-data` - Individual-level data frames (Donner, ICU, Titanicp)
```

(b) Tentative tags for each dataset

```
## Abortion
@concept loglinear-models
@concept multi-way-table
@concept mosaic-plot
@concept fourfold-plot
@concept binary-response
@concept survey-data

## Accident
@concept loglinear-models
@concept logistic-regression
@concept poisson-regression
@concept multi-way-table
@concept mosaic-plot
@concept ordered-factors
@concept demographics

## AirCrash
@concept correspondence-analysis
@concept two-way-table
@concept mosaic-plot
```

The complete scheme is described in these documents:

* [Dataset Classification Scheme for vcdExtra Package]()
* [Dataset Concept Tags Proposal]()

## `vcd::woolf_test()` for homogeneity of odds ratios
## 
Only handles 3-way tables, 2 x 2 x k. Could extend this simply to the 2 x 2 x R x C case by taking all the R x C strata
together, making this into a 2 x 2 x k table where k=R*C

e.g., for the `Fungicide` data, 2 x 2 x 2 x 2, `woolf_test()` gives an uninformative error.

```{r error=TRUE}
library(vcdExtra)
data(Fungicide, package = "vcdExtra")
# rearrange `group` for ease of interpretation, so odds ratio > 1 means worse outcome for Treated group
Fungicide <- Fungicide[2:1, , , ]
ftable(sex + strain ~ outcome + group, data=Fungicide)

oddsratio(Fungicide) |>
  summary()

#' Woolf test only only handles 2 x 2 x k tables
try(woolf_test(Fungicide))
```

#### Visualize the odds ratios

```{r fourfold}
fourfold(Fungicide, p_adjust_method = "none")
```

### Generalized `woolf_test()`
I generalized this in two ways:

#### Allow 3+ dimension

All dimensions after the first two are coalesced into a single 3rd dimension consisting of the combinations of all levels of these dimensions. We get a single overall test of differences
in odds ratios for the collection of 2 x 2 tables.

```{r woolf-general}
source(here::here("extra", "woolf_test_general.R"))

woolf_test_general(Fungicide)
```

**Source code**: [woolf_test_general.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_general.R)

**Recommendation**: This version, `woolf_test_general()` should replace `vcd::woolf_test()`. Can do this in {vcdExtra} simply by masking the
version in {vcd}


#### Four-way case of 2 x 2 x R x C

A more interesting generalization for the four-way case of 2 x 2 x R x C is to
treat the odds ratios as two-ways table of size R x C and calculate 
Woolf's test over rows, columns and for the residual.

```{r woolf-2way}
source(here::here("extra", "woolf_test_2way.R"))

woolf_test_2way(Fungicide)
```

Source code: [woolf_test_2way.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_2way.R)

**TODO**: This idea could also be incorporated into `woolf_test()`, but I'm not sure quite how.


## `vcd::assocstats()` print method

