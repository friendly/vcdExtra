---
title: "Extending Categorical Data Analysis"
author: "Michael Friendly"
date: "`r Sys.Date()`"
output: 
  html_document
---


```{r knitr-options, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,   # avoid warnings and messages in the output
  message = FALSE)

```


```{r load-packages}
library(dplyr)
library(vcdExtra)
```

Here are some notes on some {vcd} and {vcdExtra} functions that could be made more usable, better documented or illustrated in examples.

They are prompted by the fact that I'm teaching my [Categorical Data Analysis course](https://friendly.github.io/6135/) again this year, but also from the view that
statistical and graphic methods for categorical data have lagged far behind recent developments for traditional quantitative data.
This might be a good time to look these over and try to make them more coherent and useful. 

## Task View

Hey, what about a CRAN **Task View for Categorical Data Analysis**?

Here's the start of such a list: 

* {vcd}, {vcdExtra}, {gnm}, {pscl}, {MASS}, {nestedLogit} : functions for standard loglinear, glm models and extensions
* {VGAM} ...

What other packages should be added?

A more detailed look at this possibility is included in the document
[CRAN Task View: Categorical Data Analysis](https://github.com/friendly/vcdExtra/blob/master/issues/CDA-Task-View.md)

## tidyCat {#tidycat}

> Frequency tables need some Tidy Love ❤️

Tidy methods for quantitative data & models have advanced considerably, but there hasn't been much
development of similar ideas for "categorical data", by which I mean data that is often compactly represented
as $n$-way frequency tables, cross classified by one or more discrete factors. 

The vignette [tidyCat: Tidy Methods For Categorical Data Analysis](https://friendly.github.io/vcdExtra/articles/tidyCats.html) gives some initial thoughts on this topic.

## vcd documentation {#vcd-doc}

I recently did an overhaul of {vcdExtra} to: 

* Convert `.Rd` documentation to `roxygen` format. That was painful, because the {rd2roxygen} package made a mess of formatting, but the result is now much easier to maintain and extend. A benefit was that all datasets in the package are now documented in a single file, `R/data.R`, facilitating maintenance.

* Group statistical and graphic methods in broader categories for user ease in seeing what's related. Most functions already use `@seealso`, but the documentation
is much clearer using `@family` tags.  In v. 0.8.7, I introduced the following in {vcdExtra} and this kind of classification would be very useful in {vcd}.

### `@family` tags


```r
# Mosaic plotting functions
@family mosaic plots
# Functions: mosaic.glm, mosaic.glmlist, mosaic3d, sieve.glm, assoc.glm

# Model list utilities
@family glmlist functions
# Functions: glmlist, print.glmlist, LRstats, Kway, mosaic.glmlist

# Statistical tests
@family association tests
# Functions: CMHtest, GKgamma, HLtest, zero.test

# Loglinear model utilities
@family loglinear models
# Functions: seq_loglm, loglmlist, conditional, joint, mutual, markov, saturated

# Data manipulation
@family data manipulation
# Functions: expand.dft, collapse.table, cutfac, datasets

# Model comparison
@family model comparison
# Functions: LRstats, Summarise, modFit, Kway
```

### `@concept` tags

* Provide a better way to use / understand the many datasets provided by the package. For this, I introduced `@concept` tags in the {heplots} package documentation to classify each dataset according to the methods applicable to them. I also applied this idea to the {HistData} package. The vignette [Data sets in the heplots package](https://friendly.github.io/heplots/articles/datasets.html) describes how this was done. 

  * What are the "concepts" for vcd/vcdExtra datasets? I've done the initial steps on this: (a) A classification scheme based on categories of
  **Statistical Methods**, **Data Structures**, **Graphical Methods**, ... For example:

```
### 1. **Statistical Methods** (primary analysis techniques)
- `loglinear-models` - Datasets for loglinear model analysis (~40+ datasets)
- `logistic-regression` - Binary/multinomial logistic models (Donner, ICU, Accident, Titanicp)
- `poisson-regression` - Poisson GLM applications (Accident, Cormorants, DaytonSurvey)
- `correspondence-analysis` - CA methods (AirCrash, Asbestos, HairEyePlace, HospVisits, Mental)
- `association-models` - Quasi-independence, RC models (Hauser79, Yamaguchi87, JobSat)
- `observer-agreement` - Agreement/reliability analysis (Mammograms)
- `count-models` - Zero-inflated, negative binomial (PhdPubs, CyclingDeaths, Depends)

### 2. **Data Structures**
- `two-way-table` - 2D contingency tables (Glass, JobSat, Mammograms, Mobility)
- `multi-way-table` - 3+ dimensional tables (Abortion, Bartlett, Caesar, Dyke, Heckman)
- `square-table` - Same categories for rows/columns (Glass, Hauser79, Mobility, Yamaguchi87)
- `stratified-table` - Layered analysis (Fungicide, Heart, HairEyePlace, Yamaguchi87)
- `ordered-factors` - Ordinal variables (Accident, Asbestos, JobSat, Mental, Toxaemia)
- `case-form-data` - Individual-level data frames (Donner, ICU, Titanicp)
```

(b) Using this scheme, here are some Tentative tags for a few datasets

```
## Abortion
@concept loglinear-models
@concept multi-way-table
@concept mosaic-plot
@concept fourfold-plot
@concept binary-response
@concept survey-data

## Accident
@concept loglinear-models
@concept logistic-regression
@concept poisson-regression
@concept multi-way-table
@concept mosaic-plot
@concept ordered-factors
@concept demographics

## AirCrash
@concept correspondence-analysis
@concept two-way-table
@concept mosaic-plot
```

The complete scheme is described in these documents:

* [Dataset Classification Scheme for vcdExtra Package](https://github.com/friendly/vcdExtra/blob/master/issues/dataset_classification.md)
* [Dataset Concept Tags Proposal](https://github.com/friendly/vcdExtra/blob/master/issues/dataset_concepts.md)

Feedback on these categories and classifications would be very helpful before I implement this.

### `vcd` Datasets

There are 33 datasets in the {vcd} package. Would the same categories apply? (`one-way-table` would be new here)

```{r vcd-datasets}
datasets("vcd", maxTitle=30) 
```

Here are the one-way tables

```{r}
datasets("vcd", ndim=TRUE) |> dplyr::filter(ndim==1)
```


## Documentation examples

Some functions and datasets have extensive examples, some have only the bare minimum. It would be useful to revisit these in both
{vcd} and {vcdExtra}

## Function improvements

Can some of the functions in these packages be generalized to be of (a) wider scope or (b) produce better output?
I'll list here a few things I've found

### `vcd::woolf_test()` for homogeneity of odds ratios {#woolf-test}

Only handles 3-way tables, 2 x 2 x k. Could extend this simply to the 2 x 2 x R x C case by taking all the R x C strata
together, making this into a 2 x 2 x k table where k=R*C

e.g., for the `Fungicide` data, 2 x 2 x 2 x 2, `woolf_test()` gives an uninformative error.

```{r error=TRUE}
library(vcdExtra)
data(Fungicide, package = "vcdExtra")
# rearrange `group` for ease of interpretation, so odds ratio > 1 means worse outcome for Treated group
Fungicide <- Fungicide[2:1, , , ]
ftable(sex + strain ~ outcome + group, data=Fungicide)

oddsratio(Fungicide) |>
  summary()

#' Woolf test only only handles 2 x 2 x k tables
try(woolf_test(Fungicide))
```

#### Visualize the odds ratios

```{r fourfold}
fourfold(Fungicide, p_adjust_method = "none")
```

### Generalized `woolf_test()`
I generalized this in two ways:

#### Allow 3+ dimension

All dimensions after the first two are coalesced into a single 3rd dimension consisting of the combinations of all levels of these dimensions. We get a single overall test of differences
in odds ratios for the collection of 2 x 2 tables.

```{r woolf-general}
source(here::here("extra", "woolf_test_general.R"))

woolf_test_general(Fungicide)
```

**Source code**: [woolf_test_general.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_general.R)



#### Four-way case of 2 x 2 x R x C

A more interesting generalization for the four-way case of 2 x 2 x R x C is to
treat the odds ratios as two-ways table of size R x C and calculate 
Woolf's test over rows, columns and for the residual.

```{r woolf-2way}
source(here::here("extra", "woolf_test_2way.R"))

woolf_test_2way(Fungicide)
```

Source code: [woolf_test_2way.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_2way.R)

#### Fully general version

This combines the ideas of these two enhancements, into a new version of `woolf_test()`. The case of a 4-way table
is handled specially, with a new `decompose` argument, where `decompose == TRUE` does the row/col decomposition.
It also has a new print method, which shows the OR variables, strata variables explicitly, and is fully documented
in roxygen format.


```{r woolf-test-new}
source(here::here("extra", "woolf_test_new.R"))

woolf_test(Fungicide)

woolf_test(Fungicide, decompose = TRUE)
```

Source code: [woolf_test_new.R](https://github.com/friendly/vcdExtra/blob/master/extra/woolf_test_new.R)

#### Recommendation

This version of `woolf_test()` should replace `vcd::woolf_test()`. I can do this in {vcdExtra} simply by masking the
version in {vcd}, but it should better go into {vcd}.

I'm already overriding `print.Kappa()` which gives this message when I load the package:

```
Registered S3 method overwritten by 'vcdExtra':
  method      from
  print.Kappa vcd 
```

## `vcd::assocstats()` print method

This is another case that could use work to make the results more comprehensible. At present, we get a list of the table LR, Pearson
stats and coefficients for all the strata.


## mosaic plots

* `vcd::mosaic()`: It would be nice to add the facility to display the observed or expected frequency in a cell by point symbols
proportional to the count.

* It would be nice to have a `ggplot` version of mosaic plots that shows residuals from a models as in `vcd::mosaic()`. The `ggmosaic` package only provides marimekko charts. This seems to require a `stat_mosaic()` that calculates a fitted loglinear model
and finds residuals for the cells.

  * forked https://github.com/haleyjeppson/ggmosaic as https://github.com/friendly/ggmosaic

